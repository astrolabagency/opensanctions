#---------------(Generated By Cigen)---------------
---
- hosts: dgauction-dev_network
  become: yes
  become_method: sudo
  tasks:
    - name: Create docker network
      docker_network:
        name: "{{ network_name }}"
        ipam_config:
          - subnet: "{{ net_id }}.0/16"
            gateway: "{{ net_id }}.1"

- hosts: dev
  gather_facts: no
  become: yes
  become_method: sudo

  tasks:
    - name: Log into docker registry and force re-authorization
      docker_login:
        registry: "{{ registry_url }}"
        username: "{{ registry_user }}"
        password: "{{ registry_password }}"
        reauthorize: yes

    - name: start container
      docker_container:
        name: "{{ c_name }}"
        image: "{{ image_name }}"
        pull: yes
        restart_policy: unless-stopped
        hostname: "{{ h_name }}"
        exposed_ports:
        - "3000"
        #volumes:
          #- /usr/share/orgaboutique:/root/app/images
        networks:
          - name: "{{ network_name }}"
            ipv4_address: "{{ net_id }}.{{ host_id}}"
        purge_networks: yes

- hosts: dgauction-dev_clean
  gather_facts: no
  become: yes
  become_method: sudo

  tasks:
    - name: Removing exited containers
      shell: docker ps -a -q -f status=exited | xargs --no-run-if-empty docker rm --volumes
    - name: Removing untagged images
      shell: docker images | awk '/^<none>/ { print $3 }' | xargs --no-run-if-empty docker rmi -f
    - name: Removing volume directories
      shell: docker volume ls -q --filter="dangling=true" | xargs --no-run-if-empty docker volume rm
